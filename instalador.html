<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="./manifest.json">
<title>Agenda ‚Äì Instalador Offline</title>

<style>
    body {
        background: #000;
        color: #fff;
        font-family: system-ui, sans-serif;
        padding: 20px;
        text-align: center;
    }
    .box {
        background: #111;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 20px;
        margin: 20px auto;
        max-width: 500px;
        text-align: left;
        font-family: monospace;
    }
    .status-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
    }
    .btn {
        width: 100%;
        padding: 14px;
        margin-top: 12px;
        border-radius: 10px;
        border: none;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        background: #2196F3;
        color: #fff;
    }
    .btn-secondary {
        background: #333;
    }
    .btn-install {
        background: #4CAF50;
    }
</style>
</head>

<body>

<h1>üìÖ Agenda ‚Äì Instalador Offline</h1>
<p>Comprueba, instala y cachea todos los archivos de la app.</p>

<div class="box">
    <div class="status-item">
        <span id="sw-icon">‚è≥</span>
        <span id="sw-text">Service Worker: comprobando‚Ä¶</span>
    </div>

    <div class="status-item">
        <span id="cache-icon">‚è≥</span>
        <span id="cache-text">Cach√©: comprobando‚Ä¶</span>
    </div>

    <div class="status-item">
        <span id="files-icon">‚è≥</span>
        <span id="files-text">Archivos: verificando‚Ä¶</span>
    </div>
</div>

<button class="btn" onclick="forceCacheAll()">üì¶ Cachear todos los archivos</button>

<!-- ‚≠ê NUEVO BOT√ìN DE INSTALAR ‚≠ê -->
<button class="btn btn-install" id="installBtn" style="">
    üì± Instalar Agenda
</button>

<button class="btn btn-secondary" onclick="openApp()">‚û°Ô∏è Abrir Agenda</button>

<script>
/* Archivos reales de tu PWA Agenda */
const FILES = [
    "./index.html",
    "./agenda.html",
    "./ajustes.html",
    "./finanzas.html",
    "./generador.html",
    "./horario.html",
    "./notas.html",
    "./proyectos.html",
    "./salud.html",
    "./task.html",
    "./style.css",
    "./db.js",
    "./manifest.json",
    "./sw.js",
    "./icons/icon-192.png",
    "./icons/icon-512.png"
];

function setStatus(id, icon, text) {
    document.getElementById(id + "-icon").textContent = icon;
    document.getElementById(id + "-text").textContent = text;
}

/* 1) Registrar Service Worker */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js")
        .then(() => setStatus("sw", "‚úÖ", "Service Worker activo"))
        .catch(() => setStatus("sw", "‚ùå", "Error registrando SW"));
} else {
    setStatus("sw", "‚ùå", "Navegador sin soporte SW");
}

/* 2) Verificar cach√© existente */
async function checkCache() {
    if (!("caches" in window)) {
        setStatus("cache", "‚ùå", "Cach√© no soportada");
        return;
    }

    const keys = await caches.keys();
    if (keys.length === 0) {
        setStatus("cache", "‚ö†Ô∏è", "Cach√© vac√≠a");
        return;
    }

    setStatus("cache", "‚úÖ", "Cach√© detectada");
}
checkCache();

/* 3) Verificar si TODOS los archivos est√°n en cach√© */
async function verifyFiles() {
    const keys = await caches.keys();
    if (keys.length === 0) {
        setStatus("files", "‚ö†Ô∏è", "No hay cach√© a√∫n");
        return;
    }

    const cache = await caches.open(keys[0]);
    let missing = [];

    for (const file of FILES) {
        const match = await cache.match(file);
        if (!match) missing.push(file);
    }

    if (missing.length === 0) {
        setStatus("files", "‚úÖ", "Todos los archivos est√°n en cach√©");
    } else {
        setStatus("files", "‚ùå", "Faltan archivos: " + missing.join(", "));
    }
}
verifyFiles();

/* 4) Forzar cacheo de TODOS los archivos */
async function forceCacheAll() {
    setStatus("files", "‚è≥", "Cacheando archivos‚Ä¶");

    const cache = await caches.open("agenda-cache-v1");

    for (const file of FILES) {
        try {
            const res = await fetch(file, { cache: "reload" });
            await cache.put(file, res.clone());
        } catch (e) {
            console.warn("No se pudo cachear:", file);
        }
    }

    setStatus("files", "‚úÖ", "Todos los archivos cacheados");
}

/* ‚≠ê 5) BOT√ìN DE INSTALAR ‚≠ê */
let deferredPrompt = null;

window.addEventListener("beforeinstallprompt", e => {
    e.preventDefault();
    deferredPrompt = e;

    const btn = document.getElementById("installBtn");
    btn.style.display = "block";

    btn.onclick = async () => {
        btn.disabled = true;
        await deferredPrompt.prompt();
        deferredPrompt = null;
    };
});

/* 6) Abrir la app */
function openApp() {
    location.href = "./index.html";
}
</script>

</body>
</html>
