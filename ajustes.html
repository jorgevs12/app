<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="./manifest.json">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ajustes - Dashboard Pro</title>
    
    <link rel="stylesheet" href="style.css">
    <script src="db.js"></script>

    <style>
        /* Estilos espec√≠ficos de Ajustes */
        .header-nav { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .header-title { font-size: 2rem; font-weight: 800; margin: 0; }
        .section-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--text-muted); margin: 30px 0 10px 15px; font-weight: 700;
        }

        .settings-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            overflow: hidden;
            display: flex; flex-direction: column;
            backdrop-filter: blur(var(--blur-strength));
        }

        .settings-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 18px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            width: 100%; text-align: left;
            color: var(--text-primary); font-size: 1rem;
            background: transparent; border-left: none; border-right: none; border-top: none;
            cursor: pointer; transition: background 0.2s;
        }
        .settings-item:active { background: rgba(255,255,255,0.05); }
        .settings-item:last-child { border-bottom: none; }
        .settings-item.no-action { cursor: default; }
        .settings-item.danger { color: var(--accent-red); }

        .item-left { display: flex; align-items: center; gap: 15px; }
        .icon-box {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.1rem;
        }

        .item-text { font-weight: 500; display: flex; flex-direction: column; }
        .item-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; font-weight: 400; }

        /* Colores */
        .bg-blue { background: #0A84FF; }
        .bg-purple { background: #BF5AF2; }
        .bg-orange { background: #FF9F0A; }
        .bg-red { background: rgba(255, 69, 58, 0.2); color: #ff453a; }
        .bg-gray { background: #3a3a3c; }

        /* Switch iOS */
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #3a3a3c; border-radius: 34px; transition: .3s;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px;
            left: 2px; bottom: 2px; background-color: white; border-radius: 50%;
            transition: .3s;
        }
        input:checked + .slider { background-color: var(--accent-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        .color-row { display: flex; gap: 15px; padding: 10px; justify-content: space-around; }
        .color-circle {
            width: 34px; height: 34px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; transition: 0.2s;
        }
        .color-circle.active { border-color: white; transform: scale(1.1); }
    </style>
</head>
<body onload="initSettings()">

<div class="container">
    
    <div class="header-nav">
        <a href="index.html" class="back-btn" style="text-decoration: none; font-size: 1.5rem;">‚Üê</a>
        <h1 class="header-title">Ajustes</h1>
    </div>

    <div class="section-label">Personalizaci√≥n</div>
    <div class="settings-card" style="padding: 15px;">
        <div style="margin-bottom: 10px; font-size: 0.9rem; padding-left: 10px;">Color de Acento</div>
        <div class="color-row">
            <div class="color-circle" style="background:#3b82f6;" onclick="changeColor('#3b82f6')"></div>
            <div class="color-circle" style="background:#10b981;" onclick="changeColor('#10b981')"></div>
            <div class="color-circle" style="background:#f59e0b;" onclick="changeColor('#f59e0b')"></div>
            <div class="color-circle" style="background:#8b5cf6;" onclick="changeColor('#8b5cf6')"></div>
            <div class="color-circle" style="background:#ef4444;" onclick="changeColor('#ef4444')"></div>
        </div>
    </div>

    <div class="section-label">Sistema</div>
    <div class="settings-card">
        <div class="settings-item no-action">
            <div class="item-left">
                <div class="icon-box bg-purple">üì≥</div>
                <div class="item-text">Vibraci√≥n H√°pica<span class="item-desc">Feedback al tocar elementos</span></div>
            </div>
            <label class="switch">
                <input type="checkbox" id="check-haptic" onchange="toggleSetting('enableHaptic', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="section-label">Copia de Seguridad</div>
    <div class="settings-card">
        <button class="settings-item" onclick="exportFullBackup()">
            <div class="item-left">
                <div class="icon-box bg-orange">üì¶</div>
                <div class="item-text">Exportar Todo<span class="item-desc">Salud, Finanzas, Horario y Tareas</span></div>
            </div>
            <span>‚ûî</span>
        </button>

        <button class="settings-item" onclick="document.getElementById('file-input').click()">
            <div class="item-left">
                <div class="icon-box bg-blue">üì•</div>
                <div class="item-text">Restaurar Copia<span class="item-desc">Carga un archivo .json previo</span></div>
            </div>
            <span>‚ûî</span>
        </button>
        <input type="file" id="file-input" accept=".json" style="display:none" onchange="importFullBackup(event)">
    </div>

    <div class="section-label">Seguridad</div>
    <div class="settings-card" style="border-color: rgba(239, 68, 68, 0.2);">
        <button class="settings-item danger" onclick="resetDatabase()">
            <div class="item-left">
                <div class="icon-box bg-red">üóëÔ∏è</div>
                <div class="item-text">Restablecer Sistema</div>
            </div>
        </button>
    </div>
</div>

<script>
    async function initSettings() {
        await App.init();
        
        // Cargar config guardada
        const haptic = await App.getConfig('enableHaptic');
        document.getElementById('check-haptic').checked = haptic === true;
        
        const color = await App.getConfig('accentColor') || '#3b82f6';
        updateActiveColor(color);
    }

    async function toggleSetting(key, value) {
        await App.setConfig(key, value);
        if (key === 'enableHaptic' && value && navigator.vibrate) navigator.vibrate(20);
    }

    async function changeColor(color) {
        await App.setConfig('accentColor', color);
        document.documentElement.style.setProperty('--accent-blue', color);
        updateActiveColor(color);
        if (App.toast) App.toast("Color actualizado");
    }

    function updateActiveColor(color) {
        document.querySelectorAll('.color-circle').forEach(c => {
            const circleColor = c.style.backgroundColor;
            // Convertir a HEX si es necesario para comparar
            c.classList.toggle('active', circleColor.includes(color) || color.includes(circleColor));
        });
    }

    // --- L√ìGICA DE EXPORTACI√ìN TOTAL ---
    async function exportFullBackup() {
        try {
            App.toast('Preparando paquete...', 'info');
            const backup = {
                version: 2.0,
                timestamp: new Date().toISOString(),
                stores: {}
            };

            // Recorremos todos los stores definidos en db.js
            for (const key in App.STORES) {
                const storeName = App.STORES[key];
                backup.stores[storeName] = await App.read(storeName);
            }

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Backup_Total_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            App.toast('Copia descargada');
        } catch (e) {
            App.toast('Error al exportar', 'error');
        }
    }

    // --- L√ìGICA DE IMPORTACI√ìN TOTAL ---
    async function importFullBackup(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const backup = JSON.parse(e.target.result);
                if (!backup.stores) throw new Error("Archivo no compatible");

                if (!confirm("Esto reemplazar√° todos los datos actuales por los de la copia. ¬øContinuar?")) return;

                App.toast('Restaurando...', 'info');

                for (const storeName in backup.stores) {
                    const items = backup.stores[storeName];
                    
                    // 1. Limpiar el store actual (Opcional pero recomendado para evitar basura)
                    const existing = await App.read(storeName);
                    for (const oldItem of existing) {
                        await App.delete(storeName, oldItem.id);
                    }

                    // 2. Insertar los nuevos items
                    for (const item of items) {
                        // Eliminamos el ID antiguo para que IndexedDB genere nuevos o use los del backup
                        // Si quieres mantener IDs exactos, aseg√∫rate de que App.create use .put() internamente
                        await App.create(storeName, item);
                    }
                }

                App.toast('Restauraci√≥n exitosa');
                setTimeout(() => window.location.reload(), 1000);
            } catch (err) {
                App.toast('Error: Archivo inv√°lido', 'error');
            }
        };
        reader.readAsText(file);
    }

    function resetDatabase() {
        if (confirm("‚ö†Ô∏è ¬øBORRAR TODO?\nSe perder√°n salud, gastos, tareas y horario para siempre.")) {
            const req = indexedDB.deleteDatabase('AgendaDB');
            req.onsuccess = () => {
                alert("Datos borrados. Reiniciando...");
                window.location.href = 'index.html';
            };
        }
    }
</script>

</body>
</html>