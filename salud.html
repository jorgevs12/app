<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="./manifest.json">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Salud Pro - Agenda Core</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="db.js"></script>
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- EST√âTICA UNIFICADA (Estilo Horario) --- */
        body {
            background-image: radial-gradient(circle at 50% -15%, #1c1c1e 0%, #000000 60%);
            min-height: 100vh;
        }

        .container {
            width: 100%; max-width: 480px; margin: 0 auto; 
            padding: 20px; padding-top: env(safe-area-inset-top, 20px);
        }

        /* Cabecera Estilo Horario */
        header {
            display: flex; align-items: center; gap: 20px;
            margin-bottom: 32px;
        }

        .back-btn {
            width: 45px; height: 45px;
            background: rgba(255,255,255,0.08); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-primary); font-size: 1.4rem; text-decoration: none;
            transition: background 0.3s; border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            padding-bottom: 2px;
        }
        .back-btn:active { background: rgba(255,255,255,0.18); }

        .header-title {
            font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px;
            text-transform: uppercase;
            background: linear-gradient(180deg, #ffffff 0%, #a1a1aa 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 0;
        }

        /* --- TARJETAS GRANDES --- */

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Cambio a 2 columnas para que sean m√°s grandes */
            gap: 12px;
            margin-bottom: 24px;
        }
        /* La tarjeta de Actividad (Pasos) la hacemos ocupar todo el ancho */
        .stat-card.full-width {
            grid-column: span 2;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
        }

        .stat-card {
            background: rgba(30, 32, 34, 0.6); backdrop-filter: blur(20px);
            border: 1px solid var(--card-border); border-radius: 22px;
            padding: 20px 10px; /* M√°s padding interno */
            display: flex; flex-direction: column; align-items: center;
            text-align: center;
            min-height: 150px; /* Altura m√≠nima aumentada */
        }

        .stat-label { 
            font-size: 0.8rem; /* Fuente m√°s grande */
            color: var(--text-secondary); 
            text-transform: uppercase; 
            font-weight: 700; 
            margin-bottom: 10px; 
        }
        .stat-sub { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            margin-top: auto; 
            padding-top: 5px;
        }

        /* Anillos SVG - AUMENTADOS */
        .ring-container { 
            width: 80px; height: 80px; /* Aumentado de 50 a 80 */
            position: relative; margin: 4px 0; 
        }
        .ring-bg { fill: none; stroke: rgba(255,255,255,0.08); stroke-width: 6; }
        .ring-progress { 
            fill: none; stroke-width: 6; stroke-linecap: round; 
            transform: rotate(-90deg); transform-origin: 50% 50%; 
            transition: stroke-dashoffset 1s ease; 
        }
        .ring-text { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 1.1rem; /* Texto interior m√°s grande */
            font-weight: 800; color: #fff; 
        }

        /* Tabs Glass */
        .tabs-wrapper {
            background: rgba(118, 118, 128, 0.24); backdrop-filter: blur(10px);
            padding: 4px; border-radius: 14px; display: flex; margin-bottom: 24px;
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 12px; font-size: 0.95rem; font-weight: 600;
            color: var(--text-muted); border-radius: 10px; cursor: pointer; transition: all 0.2s;
        }
        .tab-btn.active { background: rgba(255,255,255,0.15); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* Estilos Generales */
        .glass-card {
            background: rgba(30, 32, 34, 0.72); backdrop-filter: blur(30px);
            border: 1px solid var(--card-border); border-radius: 24px;
            padding: 20px; margin-bottom: 20px;
        }
        .glass-input {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3);
            border: 1px solid var(--card-border); border-radius: 14px;
            color: #fff; font-size: 1rem; outline: none; transition: border-color 0.2s;
        }
        .glass-input:focus { border-color: var(--accent-blue); background: rgba(0,0,0,0.5); }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .inp-group label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; margin-left: 4px; font-weight: 600; text-transform: uppercase; }

        .btn-action {
            width: 100%; padding: 16px; border: none; border-radius: 14px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; margin-top: 10px; color: white; transition: transform 0.1s;
        }
        .btn-action:active { transform: scale(0.98); }
        .bg-blue { background: var(--accent-blue); }
        .bg-orange { background: var(--accent-orange); }
        .bg-green { background: var(--accent-green); }

        .form-view { display: none; animation: fadeIn 0.3s ease; }
        .form-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Controles Gr√°fica */
        .chart-controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; justify-content: center; }
        .chart-pill {
            padding: 8px 16px; font-size: 0.8rem; border-radius: 20px;
            background: rgba(255,255,255,0.05); color: var(--text-muted);
            border: 1px solid var(--card-border); cursor: pointer;
        }
        .chart-pill.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .chart-box { position: relative; height: 260px; width: 100%; }

        /* Historial */
        .hist-item {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.03); padding: 14px 16px; border-radius: 16px;
            margin-bottom: 8px;
        }
        .h-icon { width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 14px; }
        
        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 999;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #1c1c1e; width: 100%; max-width: 400px;
            padding: 24px; border-radius: 24px; border: 1px solid var(--card-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <a href="index.html" class="back-btn">‚Üê</a>
            <h1 class="header-title">SALUD PRO</h1>
        </header>

        <div class="summary-grid">
            
            <div class="stat-card full-width">
                <div>
                    <div class="stat-label" style="text-align: left;">Pasos Hoy</div>
                    <div style="font-size: 2rem; font-weight: 800; color: #fff;" id="pasos-val-big">0</div>
                    <div class="stat-sub" style="text-align: left; margin-top:5px;">Meta: <span id="pasos-meta-big">10k</span></div>
                </div>
                <div class="ring-container" style="width: 100px; height: 100px;">
                    <svg width="100" height="100"><circle class="ring-bg" cx="50" cy="50" r="42" style="stroke-width:8"></circle><circle class="ring-progress" id="ring-pasos" cx="50" cy="50" r="42" stroke="var(--accent-orange)" style="stroke-width:8"></circle></svg>
                    <div class="ring-text" style="font-size: 0.9rem;">üëü</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">IMC</div>
                <div class="ring-container">
                    <svg width="80" height="80"><circle class="ring-bg" cx="40" cy="40" r="34"></circle><circle class="ring-progress" id="ring-imc" cx="40" cy="40" r="34" stroke="var(--accent-green)"></circle></svg>
                    <div class="ring-text" id="imc-val">--</div>
                </div>
                <div class="stat-sub" id="health-badge">Calculando...</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Progreso</div>
                <div class="ring-container">
                    <svg width="80" height="80"><circle class="ring-bg" cx="40" cy="40" r="34"></circle><circle class="ring-progress" id="ring-peso" cx="40" cy="40" r="34" stroke="var(--accent-blue)"></circle></svg>
                    <div class="ring-text" id="goal-percent">0%</div>
                </div>
                <div class="stat-sub" id="goal-sub">Meta</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Kcal</div>
                <div class="ring-container">
                    <svg width="80" height="80"><circle class="ring-bg" cx="40" cy="40" r="34"></circle><circle class="ring-progress" id="ring-cal" cx="40" cy="40" r="34" stroke="var(--accent-red)"></circle></svg>
                    <div class="ring-text" id="cal-val">0</div>
                </div>
                <div class="stat-sub">de <span id="cal-meta">--</span></div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Minutos</div>
                <div class="ring-container">
                    <svg width="80" height="80"><circle class="ring-bg" cx="40" cy="40" r="34"></circle><circle class="ring-progress" id="ring-min" cx="40" cy="40" r="34" stroke="var(--accent-purple)"></circle></svg>
                    <div class="ring-text" id="min-val">0</div>
                </div>
                <div class="stat-sub">de <span id="min-meta">--</span></div>
            </div>
        </div>

        <div class="tabs-wrapper">
            <div class="tab-btn active" onclick="setTab('peso', this)">‚öñÔ∏è Peso</div>
            <div class="tab-btn" onclick="setTab('actividad', this)">üëü Actividad</div>
            <div class="tab-btn" id="tab-conf" onclick="setTab('config', this)">üéØ Objetivos</div>
        </div>

        <div id="view-peso" class="form-view active">
            <div class="glass-card">
                <div class="grid-2">
                    <div class="inp-group"><label>Peso (kg)</label><input type="number" id="in-peso" class="glass-input" placeholder="0.0" step="0.1"></div>
                    <div class="inp-group"><label>% Grasa</label><input type="number" id="in-grasa" class="glass-input" placeholder="%" step="0.1"></div>
                </div>
                <div class="grid-2">
                    <div class="inp-group"><label>% M√∫sculo</label><input type="number" id="in-musculo" class="glass-input" placeholder="%" step="0.1"></div>
                    <div class="inp-group"><label>% Agua</label><input type="number" id="in-agua" class="glass-input" placeholder="%" step="0.1"></div>
                </div>
                <button class="btn-action bg-blue" onclick="saveWeightEntry()">Registrar Medici√≥n</button>
            </div>
        </div>

        <div id="view-actividad" class="form-view">
            <div class="glass-card">
                <div class="grid-2">
                    <div class="inp-group"><label>Pasos</label><input type="number" id="in-pasos" class="glass-input" placeholder="0"></div>
                    <div class="inp-group"><label>Minutos Activos</label><input type="number" id="in-min" class="glass-input" placeholder="0"></div>
                </div>
                <div class="inp-group"><label>Calor√≠as Quemadas (vac√≠o = auto)</label><input type="number" id="in-cal" class="glass-input" placeholder="kcal"></div>
                <button class="btn-action bg-orange" onclick="saveActivityEntry()">Guardar Actividad</button>
            </div>
        </div>

        <div id="view-config" class="form-view">
            <div class="glass-card">
                <h3 style="margin: 0 0 20px 0; font-size:1.1rem; color:var(--text-primary);">Configuraci√≥n</h3>
                <div class="grid-2">
                    <div class="inp-group"><label>Altura (cm)</label><input type="number" id="cfg-altura" class="glass-input" placeholder="175"></div>
                    <div class="inp-group"><label>Peso Inicial (kg)</label><input type="number" id="cfg-inicial" class="glass-input" placeholder="85"></div>
                </div>
                <div class="grid-2">
                    <div class="inp-group"><label>Meta Peso (kg)</label><input type="number" id="cfg-meta" class="glass-input" placeholder="70"></div>
                    <div class="inp-group"><label>Meta Pasos</label><input type="number" id="cfg-pasos" class="glass-input" placeholder="10000"></div>
                </div>
                <div class="grid-2">
                    <div class="inp-group"><label>Meta Calor√≠as</label><input type="number" id="cfg-cal" class="glass-input" placeholder="500"></div>
                    <div class="inp-group"><label>Meta Minutos</label><input type="number" id="cfg-min" class="glass-input" placeholder="30"></div>
                </div>
                <button class="btn-action bg-green" onclick="saveConfig()">Actualizar Objetivos</button>
            </div>
        </div>

        <div class="glass-card" style="margin-top: 25px;">
            <div class="chart-controls" style="justify-content: space-between;">
                <div style="font-weight:700; color:var(--text-secondary); font-size:0.85rem;">TENDENCIA</div>
                
                <div style="display:flex; gap:5px;">
                    <div class="chart-pill" data-period="week" onclick="setChartPeriod('week', this)">7D</div>
                    <div class="chart-pill active" data-period="month" onclick="setChartPeriod('month', this)">30D</div>
                    <div class="chart-pill" data-period="year" onclick="setChartPeriod('year', this)">1A</div>
                </div>
            </div>
            
            <div class="chart-controls">
                <div class="chart-pill active" data-metric="peso" onclick="setChartMetric('peso', this)">Peso</div>
                <div class="chart-pill" data-metric="grasa" onclick="setChartMetric('grasa', this)">% Grasa</div>
                <div class="chart-pill" data-metric="pasos" onclick="setChartMetric('pasos', this)">Pasos</div>
            </div>

            <div class="chart-box">
                <canvas id="chart-canvas"></canvas>
            </div>
        </div>

        <div class="glass-card">
            <h4 style="margin:0 0 15px 0; color:var(--text-secondary); font-size:0.9rem; text-transform:uppercase;">Historial Reciente</h4>
            <div id="history-list">
                <div style="text-align:center; padding:20px; color:var(--text-muted)">Cargando...</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;" id="edit-title">Editar</h3>
            <div id="edit-form-container"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-action bg-blue" onclick="saveEditedEntry()">Guardar</button>
                <button class="btn-action" style="background:#333;" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let currentMetric = 'peso';
        let currentPeriod = 'month'; // Por defecto 30 d√≠as
        let mainChart = null;
        let editingId = null;
        let editingType = null;

        let userConfig = {
            altura: 175, inicial: 80, meta: 70, 
            pasos: 10000, calorias: 500, minutos: 30
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await App.init();
            const savedCfg = await App.getConfig('health_profile');
            if(savedCfg) userConfig = { ...userConfig, ...savedCfg };
            populateConfigForm();
            loadData();
        });

        // --- GESTI√ìN DE UI ---
        
        function setTab(viewId, btn) {
            document.querySelectorAll('.form-view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            if(btn) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        }

        function populateConfigForm() {
            document.getElementById('cfg-altura').value = userConfig.altura;
            document.getElementById('cfg-inicial').value = userConfig.inicial;
            document.getElementById('cfg-meta').value = userConfig.meta;
            document.getElementById('cfg-pasos').value = userConfig.pasos;
            document.getElementById('cfg-cal').value = userConfig.calorias;
            document.getElementById('cfg-min').value = userConfig.minutos;
        }

        async function saveConfig() {
            userConfig = {
                altura: parseFloat(document.getElementById('cfg-altura').value) || 175,
                inicial: parseFloat(document.getElementById('cfg-inicial').value) || 0,
                meta: parseFloat(document.getElementById('cfg-meta').value) || 0,
                pasos: parseInt(document.getElementById('cfg-pasos').value) || 10000,
                calorias: parseInt(document.getElementById('cfg-cal').value) || 500,
                minutos: parseInt(document.getElementById('cfg-min').value) || 30
            };
            await App.setConfig('health_profile', userConfig);
            App.toast('Perfil actualizado');
            setTab('peso', document.querySelector('.tab-btn'));
            loadData();
        }

        // --- DATOS ---

        async function loadData() {
            const rawData = await App.read(App.STORES.SALUD);
            const weights = rawData.filter(d => d.type === 'weight').sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
            const activities = rawData.filter(d => d.type === 'activity').sort((a,b) => new Date(a.fecha) - new Date(b.fecha));

            updateRings(weights, activities);
            renderChart(weights, activities);
            renderHistory(rawData);
        }

        async function saveWeightEntry() {
            const peso = parseFloat(document.getElementById('in-peso').value);
            if (!peso) return App.toast("Falta el peso", "error");

            const entry = {
                type: 'weight',
                fecha: new Date().toISOString(),
                val: peso,
                grasa: parseFloat(document.getElementById('in-grasa').value) || null,
                musculo: parseFloat(document.getElementById('in-musculo').value) || null,
                agua: parseFloat(document.getElementById('in-agua').value) || null
            };

            await App.create(App.STORES.SALUD, entry);
            App.toast("Peso registrado");
            document.querySelectorAll('#view-peso input').forEach(i => i.value = '');
            loadData();
        }

        async function saveActivityEntry() {
            const pasos = parseInt(document.getElementById('in-pasos').value) || 0;
            const min = parseInt(document.getElementById('in-min').value) || 0;
            let cal = parseFloat(document.getElementById('in-cal').value);

            if (isNaN(cal) && (pasos || min)) cal = (pasos * 0.04) + (min * 5);
            if (!pasos && !min && !cal) return App.toast("Datos vac√≠os", "error");

            const entry = {
                type: 'activity',
                fecha: new Date().toISOString(),
                steps: pasos,
                mins: min,
                cal: cal || 0
            };

            await App.create(App.STORES.SALUD, entry);
            App.toast("Actividad registrada");
            document.querySelectorAll('#view-actividad input').forEach(i => i.value = '');
            loadData();
        }

        // --- VISUALIZACI√ìN ---

        function updateRings(weights, activities) {
            // IMC
            const lastW = weights[weights.length - 1];
            if(lastW && userConfig.altura) {
                const imc = (lastW.val / Math.pow(userConfig.altura/100, 2)).toFixed(1);
                document.getElementById('imc-val').innerText = imc;
                
                let color = "var(--accent-green)", status = "Saludable";
                if(imc < 18.5) { status = "Bajo"; color = "var(--accent-blue)"; }
                else if(imc >= 25 && imc < 30) { status = "Sobrepeso"; color = "var(--accent-orange)"; }
                else if(imc >= 30) { status = "Obesidad"; color = "var(--accent-red)"; }
                
                document.getElementById('health-badge').innerText = status;
                document.getElementById('health-badge').style.color = color;
                setRing('ring-imc', (imc/40)*100, color);
            }

            // Progreso
            if(lastW && userConfig.inicial && userConfig.meta) {
                const totalDiff = Math.abs(userConfig.inicial - userConfig.meta);
                const currentDiff = Math.abs(lastW.val - userConfig.meta);
                const progress = Math.max(0, Math.min(100, ((totalDiff - currentDiff) / totalDiff) * 100));
                
                document.getElementById('goal-percent').innerText = Math.round(progress) + "%";
                document.getElementById('goal-sub').innerText = (userConfig.inicial - lastW.val).toFixed(1) + " kg cambiados";
                setRing('ring-peso', progress, 'var(--accent-blue)');
            }

            // Actividad Hoy
            const today = new Date().toISOString().slice(0,10);
            const todayActs = activities.filter(a => a.fecha.startsWith(today));
            
            const sumPasos = todayActs.reduce((acc, curr) => acc + (curr.steps || 0), 0);
            const sumCal = todayActs.reduce((acc, curr) => acc + (curr.cal || 0), 0);
            const sumMin = todayActs.reduce((acc, curr) => acc + (curr.mins || 0), 0);

            // PASOS EXACTOS (SIN REDONDEO 'k')
            document.getElementById('pasos-val-big').innerText = sumPasos.toLocaleString('es-ES');
            document.getElementById('pasos-meta-big').innerText = userConfig.pasos.toLocaleString('es-ES');

            document.getElementById('cal-val').innerText = Math.round(sumCal);
            document.getElementById('min-val').innerText = sumMin;

            document.getElementById('cal-meta').innerText = userConfig.calorias;
            document.getElementById('min-meta').innerText = userConfig.minutos;

            setRing('ring-pasos', (sumPasos/userConfig.pasos)*100, 'var(--accent-orange)');
            setRing('ring-cal', (sumCal/userConfig.calorias)*100, 'var(--accent-red)');
            setRing('ring-min', (sumMin/userConfig.minutos)*100, 'var(--accent-purple)');
        }

        function setRing(id, percent, color) {
            const circle = document.getElementById(id);
            const r = circle.r.baseVal.value;
            const c = 2 * Math.PI * r;
            const offset = c - (Math.min(percent, 100) / 100) * c;
            
            circle.style.strokeDasharray = `${c} ${c}`;
            circle.style.strokeDashoffset = offset;
            if(color) circle.style.stroke = color;
        }

        // --- GR√ÅFICA ACTUALIZADA CON FILTROS ---

        function setChartMetric(m, btn) {
            currentMetric = m;
            document.querySelectorAll('[data-metric]').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            loadData();
        }

        function setChartPeriod(p, btn) {
            currentPeriod = p;
            document.querySelectorAll('[data-period]').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            loadData();
        }

        function renderChart(weights, activities) {
            const ctx = document.getElementById('chart-canvas').getContext('2d');
            if (mainChart) mainChart.destroy();

            let dataSet = currentMetric === 'pasos' ? activities : weights;
            const now = new Date();
            let limitDate = new Date();

            // L√≥gica de Filtros de Tiempo
            if (currentPeriod === 'week') {
                limitDate.setDate(now.getDate() - 7);
            } else if (currentPeriod === 'month') {
                limitDate.setDate(now.getDate() - 30);
            } else if (currentPeriod === 'year') {
                limitDate.setDate(now.getDate() - 365);
            } else {
                limitDate = new Date(0); // Todo
            }
            
            dataSet = dataSet.filter(d => new Date(d.fecha) >= limitDate);

            const labels = dataSet.map(d => new Date(d.fecha).toLocaleDateString('es-ES', {day:'numeric', month:'short'}));
            let values = [];
            let color = '#3b82f6';

            if(currentMetric === 'peso') { values = dataSet.map(d => d.val); color = '#3b82f6'; }
            else if(currentMetric === 'grasa') { values = dataSet.map(d => d.grasa || 0); color = '#10b981'; }
            else if(currentMetric === 'pasos') { values = dataSet.map(d => d.steps || 0); color = '#f59e0b'; }

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, color + '66'); 
            gradient.addColorStop(1, color + '00');

            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: color,
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#1c1c1e',
                        pointBorderColor: color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display:false }, ticks: { color: '#888', font:{size:10} } },
                        y: { position:'right', grid: { color:'rgba(255,255,255,0.05)' }, ticks: { color:'#888', font:{size:10} } }
                    }
                }
            });
        }

        function renderHistory(rawData) {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            const sorted = rawData.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 15);

            sorted.forEach(item => {
                const div = document.createElement('div');
                div.className = 'hist-item';
                const dateStr = new Date(item.fecha).toLocaleDateString('es-ES', {day:'numeric', month:'short'});

                if (item.type === 'weight') {
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <div class="h-icon" style="background:rgba(59, 130, 246, 0.2); color:var(--accent-blue)">‚öñÔ∏è</div>
                            <div>
                                <div style="font-weight:600; font-size:0.95rem;">Peso</div>
                                <div style="font-size:0.75rem; color:var(--text-secondary)">${dateStr}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700;">${item.val} kg</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${item.grasa ? 'Grasa: ' + item.grasa + '%' : ''}</div>
                        </div>
                        <div style="margin-left:10px; opacity:0.6; font-size:1.1rem; cursor:pointer;" onclick='askDelete(${item.id})'>üóëÔ∏è</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <div class="h-icon" style="background:rgba(245, 158, 11, 0.2); color:var(--accent-orange)">üëü</div>
                            <div>
                                <div style="font-weight:600; font-size:0.95rem;">Actividad</div>
                                <div style="font-size:0.75rem; color:var(--text-secondary)">${dateStr}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700;">${item.steps.toLocaleString('es-ES')}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted)">${Math.round(item.cal)} kcal</div>
                        </div>
                        <div style="margin-left:10px; opacity:0.6; font-size:1.1rem; cursor:pointer;" onclick='askDelete(${item.id})'>üóëÔ∏è</div>
                    `;
                }
                list.appendChild(div);
            });
        }

        async function askDelete(id) {
            if(confirm('¬øEliminar registro?')) {
                await App.delete(App.STORES.SALUD, id);
                App.toast('Eliminado');
                loadData();
            }
        }

        function formatK(num) {
            return num >= 1000 ? (num/1000).toFixed(1) + 'k' : num;
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

    </script>
</body>
</html>