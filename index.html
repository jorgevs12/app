<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dashboard Pro</title>
    
    <link rel="stylesheet" href="style.css">
    <script src="db.js"></script>

    <style>
        /* --- ESTILOS ESPEC√çFICOS DEL DASHBOARD --- */
        
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 16px; 
            padding-bottom: 100px; 
        }

        .card.wide { grid-column: span 2; }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px; padding-top: 10px;
        }
        .header-left { display: flex; flex-direction: column; }
        .header-date { 
            font-size: 0.8rem; color: var(--accent-blue); 
            font-weight: 700; text-transform: uppercase; 
            letter-spacing: 1px; margin-bottom: 2px; 
        }
        .header-greet { 
            font-size: 2.2rem; font-weight: 800; line-height: 1.1; 
            letter-spacing: -1px; color: var(--text-primary);
        }

        /* Bot√≥n Ajustes */
        .btn-settings {
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; text-decoration: none; 
            transition: transform 0.2s, background 0.2s;
            backdrop-filter: blur(10px);
        }
        .btn-settings:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }

        /* Tarjetas */
        .card {
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 140px; 
            text-decoration: none; 
            color: var(--text-primary);
            position: relative;
        }
        
        .card-header { 
            display: flex; justify-content: space-between; align-items: flex-start; 
            margin-bottom: 10px; 
        }
        .card-label { 
            font-size: 0.7rem; text-transform: uppercase; 
            font-weight: 700; color: var(--text-muted); letter-spacing: 0.5px; 
        }
        .card-icon { font-size: 1.2rem; }

        .big-val { font-size: 2rem; font-weight: 800; color: #fff; line-height: 1; letter-spacing: -0.5px; }
        .sub-val { font-size: 0.85rem; color: var(--text-secondary); margin-top: 6px; font-weight: 500; }
        
        .badge { 
            font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; 
            font-weight: 700; text-transform: uppercase; display: inline-block;
        }
        .badge.urgent { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); animation: pulse 2s infinite; }
        .badge.neutral { background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); }

        /* Timeline Horario Mejorado */
        .timeline-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }
        .timeline-item:last-child { border-bottom: none; }
        
        .t-time { 
            font-size: 0.85rem; font-weight: 700; color: var(--text-muted); 
            min-width: 45px; transition: color 0.3s;
        }
        .t-info { display: flex; flex-direction: column; flex: 1; }
        .t-sub { font-size: 0.95rem; font-weight: 600; color: #fff; }
        .t-room { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

        /* Estilo para Clase Activa (En curso) */
        .timeline-item.active {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, rgba(0,0,0,0) 100%);
            border-radius: 8px;
            padding-left: 10px;
            padding-right: 10px;
            border-left: 3px solid var(--accent-green);
            margin: 4px 0;
            border-bottom: none;
        }
        .timeline-item.active .t-time { color: var(--accent-green); }
        .timeline-item.active .t-sub { color: var(--accent-green); }
        
        .active-badge {
            font-size: 0.6rem; background: var(--accent-green); color: #000;
            padding: 2px 6px; border-radius: 4px; font-weight: 800;
            margin-left: auto; text-transform: uppercase;
        }

        /* Animaciones */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .skeleton { background: rgba(255,255,255,0.08); color: transparent; border-radius: 4px; animation: pulse 1.5s infinite; }

    </style>
</head>
<body>

    <div class="container">
        
        <header>
            <div class="header-left">
                <div class="header-date" id="date-display">Cargando...</div>
                <div class="header-greet" id="greeting">Hola</div>
            </div>
            <a href="ajustes.html" class="btn-settings">‚öôÔ∏è</a>
        </header>

        <main class="dashboard-grid">
            
            <a href="agenda.html" class="glass-card wide card">
                <div class="card-header">
                    <span class="card-label" style="color:var(--accent-red)">‚óè Siguiente</span>
                    <span class="badge" id="agenda-badge">--</span>
                </div>
                <div>
                    <div class="big-val" id="agenda-title" style="font-size:1.6rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        <span class="skeleton">Cargando evento...</span>
                    </div>
                    <div class="sub-val" id="agenda-date">Revisando calendario...</div>
                </div>
            </a>

            <a href="horario.html" class="glass-card wide card">
                <div class="card-header">
                    <span class="card-label">Clases de Hoy</span>
                    <span class="card-icon">üïí</span>
                </div>
                <div id="schedule-list">
                    <div class="skeleton" style="width:100%; height:40px;"></div>
                </div>
            </a>

            <a href="salud.html" class="glass-card card">
                <div class="card-header" style="margin-bottom:5px;">
                    <span class="card-label">Salud Hoy</span>
                    <span class="card-icon">üî•</span>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:5px;">
                    <div>
                        <div class="big-val" id="health-cal" style="font-size:1.5rem;">0</div>
                        <div class="sub-val" style="color:var(--accent-orange); margin-top:2px;">Kcal</div>
                    </div>
                    
                    <div style="text-align:right;">
                        <div class="big-val" id="health-steps" style="font-size:1.5rem;">0</div>
                        <div class="sub-val" style="color:var(--accent-blue); margin-top:2px;">Pasos</div>
                    </div>
                </div>
            </a>

            <a href="finanzas.html" class="glass-card card">
                <div class="card-header">
                    <span class="card-label">Gasto Mes</span>
                    <span class="card-icon">üí∏</span>
                </div>
                <div>
                    <div class="big-val" id="finance-val">0‚Ç¨</div>
                    <div class="sub-val" style="color:var(--accent-green)">Acumulado</div>
                </div>
            </a>

            <a href="notas.html" class="glass-card wide card" style="min-height: auto; flex-direction: row; align-items: center; padding: 20px;">
                <div style="display:flex; align-items:center; gap:15px; flex:1;">
                    <div style="background:rgba(59, 130, 246, 0.15); width:48px; height:48px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">üìö</div>
                    <div>
                        <div class="card-label" style="margin-bottom:4px; color:var(--accent-blue);">Acad√©mico</div>
                        <div class="big-val" style="font-size:1.4rem;" id="academic-avg">--</div>
                        <div class="sub-val" style="margin:0; font-size:0.8rem;" id="academic-count">0 materias activas</div>
                    </div>
                </div>
                <div style="font-size:1.5rem; opacity:0.3;">‚Ä∫</div>
            </a>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await App.init();
            if(App.refreshTheme) App.refreshTheme();
            
            updateHeader();
            loadAllWidgets();

            setInterval(() => {
                updateHeader();
                loadAllWidgets();
            }, 60000);
        });

        async function loadAllWidgets() {
            await Promise.all([
                loadAgenda(),
                loadSchedule(),
                loadHealth(),
                loadFinance(),
                loadAcademic()
            ]);
        }

        // 1. HEADER
        function updateHeader() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('date-display').innerText = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

            const h = now.getHours();
            let greet = "Buenas noches";
            if(h >= 6 && h < 12) greet = "Buenos d√≠as";
            else if(h >= 12 && h < 20) greet = "Buenas tardes";
            
            App.getConfig('user_profile').then(profile => {
                const name = profile && profile.name ? profile.name : '';
                document.getElementById('greeting').innerText = name ? `${greet}, ${name}` : greet;
            });
        }

        // 2. AGENDA
        async function loadAgenda() {
            try {
                const events = await App.read(App.STORES.EVENTOS);
                const now = new Date();
                const upcoming = events
                    .filter(e => {
                        const d = new Date(e.fecha);
                        const today = new Date(); today.setHours(0,0,0,0);
                        return d >= today;
                    })
                    .sort((a,b) => new Date(a.fecha) - new Date(b.fecha));

                const titleEl = document.getElementById('agenda-title');
                const dateEl = document.getElementById('agenda-date');
                const badgeEl = document.getElementById('agenda-badge');

                if(upcoming.length === 0) {
                    titleEl.innerText = "Todo libre";
                    dateEl.innerText = "Sin eventos pr√≥ximos";
                    badgeEl.style.display = 'none';
                    return;
                }

                const next = upcoming[0];
                const nextDate = new Date(next.fecha);
                titleEl.innerText = next.titulo;
                
                const timeStr = next.hora || nextDate.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'});
                const today = new Date();
                const isToday = nextDate.toDateString() === today.toDateString();
                const diffTime = nextDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                badgeEl.style.display = 'inline-block';

                if(isToday) {
                    dateEl.innerText = `Hoy a las ${timeStr}`;
                    badgeEl.innerText = "¬°HOY!";
                    badgeEl.className = "badge urgent";
                } else if (diffDays <= 1) {
                    dateEl.innerText = `Ma√±ana a las ${timeStr}`;
                    badgeEl.innerText = "MA√ëANA";
                    badgeEl.className = "badge urgent";
                } else {
                    dateEl.innerText = nextDate.toLocaleDateString('es-ES', {weekday:'short', day:'numeric'}) + ` - ${timeStr}`;
                    badgeEl.innerText = `EN ${diffDays} D√çAS`;
                    badgeEl.className = diffDays <= 3 ? "badge urgent" : "badge neutral";
                }
            } catch (e) { console.error("Error Agenda:", e); }
        }

        // 3. HORARIO (MEJORADO: Filtra pasadas, resalta activas)
        async function loadSchedule() {
            try {
                const schedule = await App.read(App.STORES.HORARIO);
                const list = document.getElementById('schedule-list');
                list.innerHTML = '';

                const now = new Date();
                let day = now.getDay(); 
                if(day === 0) day = 7; 
                
                // Calcular minutos actuales desde las 00:00 para comparar
                const currentMinutes = now.getHours() * 60 + now.getMinutes();

                // Funci√≥n auxiliar para convertir "HH:MM" a minutos
                const getMins = (timeStr) => {
                    if(!timeStr) return 0;
                    const [h, m] = timeStr.split(':').map(Number);
                    return h * 60 + m;
                };

                // 1. Filtrar clases del d√≠a
                // 2. Filtrar clases que YA TERMINARON (fin < actual)
                // 3. Ordenar por inicio
                const upcomingClasses = schedule
                    .filter(s => parseInt(s.dia) === day)
                    .filter(s => getMins(s.horaFin) > currentMinutes) 
                    .sort((a,b) => a.horaInicio.localeCompare(b.horaInicio));

                // Si no quedan clases (todas acabaron o no hubo)
                if(upcomingClasses.length === 0) {
                    // Verificar si hab√≠a clases hoy pero ya acabaron
                    const allClassesToday = schedule.filter(s => parseInt(s.dia) === day);
                    if (allClassesToday.length > 0) {
                        list.innerHTML = '<div style="opacity:0.6; font-size:0.9rem; padding:15px 0; color:var(--accent-green);">¬°Todo listo por hoy! üéâ</div>';
                    } else {
                        list.innerHTML = '<div style="opacity:0.6; font-size:0.9rem; padding:15px 0;">No hay clases hoy.</div>';
                    }
                    return;
                }

                // Mostrar las siguientes 3
                upcomingClasses.slice(0, 3).forEach(c => {
                    const startMins = getMins(c.horaInicio);
                    const endMins = getMins(c.horaFin);
                    
                    // Verificar si est√° "En Curso" (Inicio <= Actual < Fin)
                    const isActive = (startMins <= currentMinutes && endMins > currentMinutes);
                    
                    const div = document.createElement('div');
                    div.className = `timeline-item ${isActive ? 'active' : ''}`;
                    
                    let activeBadge = isActive ? `<span class="active-badge">En Curso</span>` : '';

                    div.innerHTML = `
                        <div class="t-time">${c.horaInicio}</div>
                        <div class="t-info">
                            <span class="t-sub">${c.materia || c.titulo}</span>
                            <span class="t-room">${c.aula ? 'Aula ' + c.aula : ''}</span>
                        </div>
                        ${activeBadge}
                    `;
                    list.appendChild(div);
                });

                if(upcomingClasses.length > 3) {
                    list.innerHTML += `<div style="font-size:0.75rem; text-align:center; opacity:0.5; margin-top:5px;">+${upcomingClasses.length - 3} m√°s</div>`;
                }
            } catch (e) { console.error("Error Horario:", e); }
        }

        // 4. SALUD
        async function loadHealth() {
            try {
                const data = await App.read(App.STORES.SALUD);
                const todayStr = new Date().toDateString();
                
                let cals = 0.0;
                let steps = 0;

                data.forEach(d => {
                    const dDate = new Date(d.fecha);
                    if(dDate.toDateString() === todayStr) {
                        if(d.cal) cals += parseFloat(d.cal);
                        let p = 0;
                        if(d.pasos) p = parseFloat(d.pasos);
                        else if(d.steps) p = parseFloat(d.steps);
                        steps += p;
                    }
                });

                document.getElementById('health-cal').innerText = cals.toLocaleString('es-ES', {
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 2 
                });
                
                document.getElementById('health-steps').innerText = steps.toLocaleString('es-ES');

            } catch (e) { console.error("Error Salud:", e); }
        }

        // 5. FINANZAS
        async function loadFinance() {
            try {
                const data = await App.read(App.STORES.FINANZAS);
                const now = new Date();
                let spent = 0;

                data.forEach(f => {
                    const d = new Date(f.fecha);
                    if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                        if(f.tipo === 'gasto') spent += parseFloat(f.monto);
                    }
                });

                document.getElementById('finance-val').innerText = spent.toFixed(2) + '‚Ç¨';
                
            } catch (e) { console.error("Error Finanzas:", e); }
        }

        // 6. ACAD√âMICO
        async function loadAcademic() {
            try {
                const data = await App.read(App.STORES.NOTAS);
                const subjects = data.filter(d => d.sections && Array.isArray(d.sections));

                const count = subjects.length;
                document.getElementById('academic-count').innerText = `${count} materias`;

                if(count === 0) {
                    document.getElementById('academic-avg').innerText = "--";
                    return;
                }

                let sumAvg = 0;
                let validSubjects = 0;

                subjects.forEach(sub => {
                    let totalW = 0;
                    sub.sections.forEach(sec => {
                        if(sec.grades && sec.grades.length > 0) {
                            const secAvg = sec.grades.reduce((a,b)=>a+b.val,0) / sec.grades.length;
                            totalW += secAvg * (sec.weight/100);
                        }
                    });
                    if(totalW > 0) {
                        sumAvg += totalW;
                        validSubjects++;
                    }
                });

                const globalAvg = validSubjects > 0 ? (sumAvg / validSubjects) : 0;
                const avgEl = document.getElementById('academic-avg');
                
                avgEl.innerText = globalAvg.toFixed(2);
                
                if(globalAvg >= 5) avgEl.style.color = "var(--accent-green)";
                else if(globalAvg > 0) avgEl.style.color = "var(--accent-red)";
                else avgEl.style.color = "#fff";

            } catch (e) { 
                console.error("Error Acad√©mico:", e);
            }
        }
    </script>
</body>
</html>